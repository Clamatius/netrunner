#!/bin/bash
# Pre-commit hook: Check that AI client code compiles

set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Pre-commit: Checking AI client code..."

# Get list of staged .clj files in dev/src/clj/
STAGED_AI_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^dev/src/clj/.*\.clj$' || true)

if [ -z "$STAGED_AI_FILES" ]; then
    echo "   No AI client files changed, skipping check"
    exit 0
fi

echo "   Checking staged AI files:"
for file in $STAGED_AI_FILES; do
    echo "   - $file"
done

# Run lein check and capture output
echo "   Running compilation check..."

# Use a temp file to capture full output
TMPFILE=$(mktemp)
trap "rm -f $TMPFILE" EXIT

if lein check 2>&1 | tee "$TMPFILE" | grep -q "Syntax error\|EOF while reading\|CompilerException"; then
    echo ""
    echo -e "${RED}‚ùå Pre-commit check FAILED${NC}"
    echo ""
    echo "Compilation errors detected:"
    echo "----------------------------"
    grep -A 3 "Syntax error\|EOF while reading\|CompilerException" "$TMPFILE" || true
    echo ""
    echo "Please fix compilation errors before committing."
    echo "To skip this check (not recommended): git commit --no-verify"
    exit 1
fi

# Check for specific namespaces that should compile
if grep -q "Checking namespace ai-" "$TMPFILE"; then
    echo -e "   ${GREEN}‚úì AI client code compiles successfully${NC}"
    exit 0
else
    echo -e "${YELLOW}‚ö†Ô∏è  Warning: Could not verify AI client compilation${NC}"
    echo "   Proceeding with commit anyway..."
    exit 0
fi
