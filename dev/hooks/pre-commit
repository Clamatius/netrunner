#!/bin/bash
# Pre-commit hook: Quick syntax check for AI client code
# Uses targeted require instead of full lein check (which hangs)

set -e

# ANSI color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "üîç Pre-commit: Checking AI client code..."

# Get list of staged .clj files in dev/src/clj/
STAGED_AI_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^dev/src/clj/.*\.clj$' || true)

if [ -z "$STAGED_AI_FILES" ]; then
    echo "   No AI client files changed, skipping check"
    exit 0
fi

echo "   Checking staged AI files:"
for file in $STAGED_AI_FILES; do
    echo "   - $file"
done

# Extract namespace names from filenames (ai_foo.clj -> ai-foo)
NAMESPACES=""
for file in $STAGED_AI_FILES; do
    basename=$(basename "$file" .clj)
    # Skip files without ns form (scripts like connect_ai.clj, start_ai.clj)
    if ! grep -q "^(ns " "$file" 2>/dev/null; then
        echo "   Skipping $basename (no ns form)"
        continue
    fi
    ns=$(echo "$basename" | tr '_' '-')
    NAMESPACES="$NAMESPACES $ns"
done

if [ -z "$NAMESPACES" ]; then
    echo "   No namespaced files to check"
    exit 0
fi

echo "   Compiling namespaces:$NAMESPACES"

# Build require expression
REQUIRE_EXPR="(do"
for ns in $NAMESPACES; do
    REQUIRE_EXPR="$REQUIRE_EXPR (require '$ns)"
done
REQUIRE_EXPR="$REQUIRE_EXPR (println \"‚úì All namespaces compiled\") (System/exit 0))"

# Run with timeout - compile just the changed AI namespaces
TMPFILE=$(mktemp)
trap "rm -f $TMPFILE" EXIT

# 30 second timeout should be plenty for a few namespaces
if timeout 30 lein run -m clojure.main -e "$REQUIRE_EXPR" 2>&1 | tee "$TMPFILE"; then
    echo -e "   ${GREEN}‚úì AI client code compiles successfully${NC}"
    exit 0
fi

# Check if it was a compilation error
if grep -q "Syntax error\|EOF while reading\|CompilerException\|Unable to resolve" "$TMPFILE"; then
    echo ""
    echo -e "${RED}‚ùå Pre-commit check FAILED${NC}"
    echo ""
    echo "Compilation errors detected:"
    echo "----------------------------"
    grep -B 2 -A 5 "Syntax error\|EOF while reading\|CompilerException\|Unable to resolve" "$TMPFILE" || true
    echo ""
    echo "Please fix compilation errors before committing."
    echo "To skip this check (not recommended): git commit --no-verify"
    exit 1
fi

# Timeout or other issue - warn but allow commit
echo -e "${YELLOW}‚ö†Ô∏è  Warning: Compilation check timed out or failed${NC}"
echo "   Proceeding with commit anyway..."
exit 0
