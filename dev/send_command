#!/bin/bash
# send_command - Simplified AI player control interface
# Usage: ./send_command <action> [args...]

set -euo pipefail
set +H  # Disable history expansion to allow ! in function names

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
AI_EVAL="$SCRIPT_DIR/ai-eval.sh"
TIMEOUT="${TIMEOUT:-20}"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

error() {
    echo -e "${RED}❌ Error: $1${NC}" >&2
    exit 1
}

success() {
    echo -e "${GREEN}✅ $1${NC}"
}

info() {
    echo -e "${BLUE}ℹ️  $1${NC}"
}

warn() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

# Check if AI client is running
check_client() {
    if ! lsof -i :7889 > /dev/null 2>&1; then
        error "AI Client REPL not running. Start with: ./dev/start-ai-client-repl.sh"
    fi
}

# Ensure WebSocket connection is active (auto-reconnect if needed)
ensure_connection() {
    # Check if WebSocket client is loaded and connected
    # We check by trying to access the client-state atom which should always exist if loaded
    local check_result=$(TIMEOUT=5 "$AI_EVAL" '(do
      (try
        (require (quote [ai-websocket-client-v2 :as ws]))
        (let [state @ws/client-state
              uid (:uid state)]
          (if uid
            "connected"
            "disconnected"))
        (catch Exception e
          "error")))' 2>&1 | grep -E '^"(connected|disconnected|error)"$' | tr -d '"' || echo "error")

    if [[ "$check_result" != "connected" ]]; then
        # Silently reconnect if needed (check is fragile, so don't warn)
        TIMEOUT=10 "$AI_EVAL" '(do
          (require (quote [ai-websocket-client-v2 :as ws]))
          (ws/connect! "ws://localhost:1042/chsk")
          (Thread/sleep 2000))' > /dev/null 2>&1
        sleep 1
    fi
}

# Show help
show_help() {
    cat << EOF
${BLUE}AI Player Command Interface${NC}

${GREEN}Status Commands:${NC}
  status          - Show game state (turn, credits, clicks, hand size)
  board           - Show full game board (servers, ICE, rigs)
  hand            - Show cards in hand
  prompt          - Show current prompt (if any)
  credits         - Show current credits
  clicks          - Show remaining clicks
  archives        - Show Corp's Archives (faceup/facedown cards)
  log [N]         - Show last N game log entries (default: 20)
  card-text <name>   - Look up card information (type, cost, text)
  abilities <name>   - Show abilities for installed card

${GREEN}Basic Actions:${NC}
  start-turn      - Start your turn (gain clicks, Corp draws card)
  indicate-action - Signal you want to use paid ability (pauses game)
  take-credit     - Spend 1 click to gain 1 credit
  draw            - Spend 1 click to draw 1 card
  end-turn        - End your turn (validates all clicks used)

${GREEN}Mulligan & Hand Management:${NC}
  keep-hand       - Keep starting hand
  mulligan        - Mulligan (redraw) starting hand
  discard         - Discard down to maximum hand size

${GREEN}Card Actions:${NC}
  play <name>     - Play card by name (e.g., "Sure Gamble")
  play-index <N>  - Play card by index (0-4)
  use-ability <name> <N>  - Use installed card's ability N (e.g., "Smartware Distributor" 0)
  trash <name>    - Trash installed card by name (Corp: ICE/asset, Runner: rig)
  rez <name>      - Rez installed Corp card (ICE/asset/upgrade)
  fire-subs <name> - Fire unbroken ICE subroutines (Corp only, during runs)
  auto-pass       - Toggle auto-pass priority during runs (Corp only)
  advance <name>  - Advance installed card (Corp only: agendas, ICE, assets)
  score <name>    - Score agenda with sufficient advancement counters (Corp only)

${GREEN}Runner Actions:${NC}
  run <server>    - Run on server (HQ, "R&D", Archives, remote1, etc.)
  let-subs-fire <name> - Signal intent to let ICE subroutines fire (Runner only, during runs)

${GREEN}Prompts:${NC}
  choose <N>      - Choose option N from current prompt (0, 1, 2...)
  choose-value <text> - Choose option by matching text (e.g., "keep", "steal")
  continue        - Continue/pass priority (for paid ability windows, run phases)
  jack-out        - Jack out of current run (end run unsuccessfully)

${GREEN}Lobby:${NC}
  create-game <title> [side] [precon]  - Create new game (default: "Any Side", "worlds-2012-a")
  start-game      - Start game (after creating and opponent joins)
  leave-game      - Leave current game lobby
  list-lobbies    - List available games to join
  join <game-id> <side>  - Join game as Runner or Corp
  resync <game-id>       - Rejoin already-started game
  chat <message>         - Send chat message to game

${GREEN}Installation:${NC}
  install <name> [server]  - Install card by name (Corp needs server: HQ, "R&D", "New remote")
  install-index <N> [server] - Install card by index (Corp needs server)

${GREEN}Connection:${NC}
  connect         - Manually reconnect WebSocket to server

${GREEN}Advanced:${NC}
  eval <expr>     - Execute arbitrary Clojure expression

${YELLOW}Examples:${NC}
  ./send_command status
  ./send_command list-lobbies
  ./send_command take-credit
  ./send_command play "Sure Gamble"
  ./send_command install "Daily Casts"
  ./send_command run "R&D"
  ./send_command choose 0
  ./send_command choose-value keep
  ./send_command end-turn

EOF
}

# Execute command via ai-eval.sh
execute() {
    local expr="$1"
    TIMEOUT="$TIMEOUT" "$AI_EVAL" "$expr"
}

# Main command dispatcher
COMMAND="${1:-help}"
shift || true

check_client

case "$COMMAND" in
    # Help
    help|--help|-h)
        show_help
        ;;

    # Connection
    connect)
        info "Reconnecting to game server..."
        execute '(do
          (require (quote [ai-websocket-client-v2 :as ws]))
          (ws/connect! "ws://localhost:1042/chsk")
          (Thread/sleep 2000)
          (println "✅ Connected to ws://localhost:1042/chsk"))'
        ;;

    # Status commands (read-only)
    status)
        execute '(ai-actions/status)'
        ;;

    board)
        execute '(ai-actions/show-board)'
        ;;

    hand)
        execute '(ai-actions/show-hand)'
        ;;

    prompt)
        execute '(ai-actions/show-prompt-detailed)'
        ;;

    credits)
        execute '(ai-actions/show-credits)'
        ;;

    clicks)
        execute '(ai-actions/show-clicks)'
        ;;

    archives)
        execute '(ai-actions/show-archives)'
        ;;

    log)
        N="${1:-20}"
        [[ ! "$N" =~ ^[0-9]+$ ]] && N=20
        execute "(ai-actions/show-log $N)"
        ;;

    card-text)
        CARD_NAME="${1:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command card-text <card-name>"
        execute "(ai-actions/show-card-text \"$CARD_NAME\")"
        ;;

    hand-text)
        info "Looking up all cards in hand..."
        execute "(ai-actions/show-hand-cards)"
        ;;

    abilities)
        CARD_NAME="${1:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command abilities <card-name>"
        execute "(ai-actions/show-card-abilities \"$CARD_NAME\")"
        ;;

    # Basic actions
    start-turn)
        ensure_connection
        info "Starting turn..."
        execute '(ai-actions/start-turn!)'
        ;;

    indicate-action)
        ensure_connection
        info "Indicating paid ability..."
        execute '(ai-actions/indicate-action!)'
        ;;

    take-credit)
        ensure_connection
        info "Taking credit..."
        execute '(ai-actions/take-credit!)'
        ;;

    draw)
        ensure_connection
        info "Drawing card..."
        execute '(ai-actions/draw-card!)'
        ;;

    end-turn)
        ensure_connection
        info "Ending turn..."
        execute '(ai-actions/end-turn!)'
        ;;

    # Mulligan
    keep-hand)
        ensure_connection
        info "Keeping hand..."
        execute '(ai-actions/keep-hand)'
        ;;

    mulligan)
        ensure_connection
        info "Taking mulligan..."
        execute '(ai-actions/mulligan)'
        ;;

    discard)
        ensure_connection
        if [[ $# -eq 0 ]]; then
            info "Auto-discarding to hand size..."
            execute '(ai-actions/discard-to-hand-size!)'
        else
            # Collect all numeric indices
            INDICES=()
            for arg in "$@"; do
                if [[ "$arg" =~ ^[0-9]+$ ]]; then
                    INDICES+=("$arg")
                else
                    error "Invalid index: $arg (must be a number)"
                fi
            done
            info "Discarding specific cards at indices: ${INDICES[*]}"
            # Build Clojure vector from indices
            INDICES_VEC="[${INDICES[*]}]"
            execute "(ai-actions/discard-specific-cards! $INDICES_VEC)"
        fi
        ;;

    # Card actions
    play)
        ensure_connection
        CARD_NAME="${1:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command play <card-name>"
        info "Playing card: $CARD_NAME"
        execute "(ai-actions/play-card! \"$CARD_NAME\")"
        ;;

    play-index)
        ensure_connection
        INDEX="${1:-}"
        [[ -z "$INDEX" ]] && error "Usage: send_command play-index <0-4>"
        [[ ! "$INDEX" =~ ^[0-9]+$ ]] && error "Index must be a number"
        info "Playing card at index $INDEX"
        execute "(ai-actions/play-card! $INDEX)"
        ;;

    # Running
    run)
        ensure_connection
        SERVER="${1:-}"
        [[ -z "$SERVER" ]] && error "Usage: send_command run <server>"
        info "Running on $SERVER..."
        execute "(ai-actions/run! \"$SERVER\")"
        ;;

    # Card abilities
    use-ability)
        ensure_connection
        CARD_NAME="${1:-}"
        ABILITY_INDEX="${2:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command use-ability <card-name> <ability-index>"
        [[ -z "$ABILITY_INDEX" ]] && error "Usage: send_command use-ability <card-name> <ability-index>"
        [[ ! "$ABILITY_INDEX" =~ ^[0-9]+$ ]] && error "Ability index must be a number"
        info "Using ability $ABILITY_INDEX on $CARD_NAME..."
        execute "(ai-actions/use-ability! \"$CARD_NAME\" $ABILITY_INDEX)"
        ;;

    # Trash installed card
    trash)
        ensure_connection
        CARD_NAME="${1:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command trash <card-name>"
        info "Trashing $CARD_NAME..."
        execute "(ai-actions/trash-installed! \"$CARD_NAME\")"
        ;;

    # Rez Corp card
    rez)
        ensure_connection
        CARD_NAME="${1:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command rez <card-name>"
        info "Rezzing $CARD_NAME..."
        execute "(ai-actions/rez-card! \"$CARD_NAME\")"
        ;;

    # Fire ICE subroutines
    fire-subs)
        ensure_connection
        ICE_NAME="${1:-}"
        [[ -z "$ICE_NAME" ]] && error "Usage: send_command fire-subs <ice-name>"
        info "Firing unbroken subroutines on $ICE_NAME..."
        execute "(ai-actions/fire-unbroken-subs! \"$ICE_NAME\")"
        ;;

    # Let ICE subroutines fire (Runner)
    let-subs-fire)
        ensure_connection
        ICE_NAME="${1:-}"
        [[ -z "$ICE_NAME" ]] && error "Usage: send_command let-subs-fire <ice-name>"
        info "Signaling intent to let subs fire on $ICE_NAME..."
        execute "(ai-actions/let-subs-fire! \"$ICE_NAME\")"
        ;;

    # Toggle auto-pass priority (Corp)
    auto-pass)
        ensure_connection
        info "Toggling auto-pass priority..."
        execute "(ai-actions/toggle-auto-no-action!)"
        ;;

    # Advance card
    advance)
        ensure_connection
        CARD_NAME="${1:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command advance <card-name>"
        info "Advancing $CARD_NAME..."
        execute "(ai-actions/advance-card! \"$CARD_NAME\")"
        ;;

    # Score agenda
    score)
        ensure_connection
        CARD_NAME="${1:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command score <card-name>"
        info "Scoring $CARD_NAME..."
        execute "(ai-actions/score-agenda! \"$CARD_NAME\")"
        ;;

    # Prompts
    choose)
        ensure_connection
        CHOICE="${1:-}"
        [[ -z "$CHOICE" ]] && error "Usage: send_command choose <index>"
        [[ ! "$CHOICE" =~ ^[0-9]+$ ]] && error "Choice must be a number"
        info "Choosing option $CHOICE..."
        execute "(ai-actions/choose-option! $CHOICE)"
        ;;

    choose-value)
        ensure_connection
        VALUE="${1:-}"
        [[ -z "$VALUE" ]] && error "Usage: send_command choose-value <text>"
        info "Choosing option matching: $VALUE..."
        execute "(ai-actions/choose-by-value! \"$VALUE\")"
        ;;

    continue)
        ensure_connection
        info "Passing priority (continue)..."
        execute '(let [state @ai-websocket-client-v2/client-state
                       gameid (:gameid state)]
                  (ai-websocket-client-v2/send-message! :game/action
                    {:gameid (if (string? gameid)
                               (java.util.UUID/fromString gameid)
                               gameid)
                     :command "continue"
                     :args nil})
                  (Thread/sleep 1000)
                  (println "✅ Passed priority"))'
        ;;

    jack-out)
        ensure_connection
        info "Jacking out of run..."
        execute '(let [state @ai-websocket-client-v2/client-state
                       gameid (:gameid state)]
                  (ai-websocket-client-v2/send-message! :game/action
                    {:gameid (if (string? gameid)
                               (java.util.UUID/fromString gameid)
                               gameid)
                     :command "jack-out"
                     :args nil})
                  (Thread/sleep 1000)
                  (println "✅ Jacked out (run ended unsuccessfully)"))'
        ;;

    # Lobby
    create-game)
        ensure_connection
        TITLE="${1:-AI Test Game}"
        SIDE="${2:-Any Side}"
        PRECON="${3:-worlds-2012-a}"
        info "Creating game: $TITLE (Side: $SIDE)..."
        execute "(do
                   (require (quote [ai-websocket-client-v2 :as ws]))
                   (ws/create-lobby! {:title \"$TITLE\"
                                      :side \"$SIDE\"
                                      :format \"system-gateway\"
                                      :gateway-type \"Beginner\"
                                      :precon \"$PRECON\"
                                      :room \"casual\"
                                      :allow-spectator true
                                      :spectatorhands false
                                      :save-replay false
                                      :api-access false
                                      :password \"\"
                                      :singleton false
                                      :open-decklists false
                                      :turmoil false
                                      :timer nil})
                   (Thread/sleep 2000)
                   (println \"✅ Lobby creation request sent\"))"
        ;;

    start-game)
        ensure_connection
        info "Starting game..."
        execute '(do
                   (require (quote [ai-websocket-client-v2 :as ws]))
                   (let [state @ws/client-state
                         gameid (:gameid state)]
                     (if gameid
                       (do
                         (ws/send-message! :game/start {:gameid gameid})
                         (Thread/sleep 2000)
                         (println "✅ Game start signal sent"))
                       (println "❌ Not in a game lobby"))))'
        ;;

    leave-game)
        ensure_connection
        info "Leaving game lobby..."
        execute '(do
                   (require (quote [ai-websocket-client-v2 :as ws]))
                   (let [state @ws/client-state
                         gameid (:gameid state)]
                     (if gameid
                       (do
                         (ws/send-message! :lobby/leave {:gameid gameid})
                         (Thread/sleep 1000)
                         ;; Clear client state after leaving
                         (swap! ws/client-state assoc :gameid nil :side nil)
                         (println "✅ Left game lobby"))
                       (println "⚠️  Not in a game lobby"))))'
        ;;

    list-lobbies)
        ensure_connection
        info "Fetching lobby list..."
        execute '(do
                   (require (quote [ai-websocket-client-v2 :as ws]))
                   (println "Requesting lobby list...")
                   (ws/request-lobby-list!)
                   (Thread/sleep 1000)
                   (ws/show-games))'
        ;;

    join)
        ensure_connection
        GAME_ID="${1:-}"
        SIDE="${2:-Runner}"
        [[ -z "$GAME_ID" ]] && error "Usage: send_command join <game-id> [Runner|Corp]"
        info "Joining game $GAME_ID as $SIDE..."
        execute "(ai-actions/connect-game! \"$GAME_ID\" \"$SIDE\")"
        ;;

    resync)
        ensure_connection
        GAME_ID="${1:-}"
        [[ -z "$GAME_ID" ]] && error "Usage: send_command resync <game-id>"
        info "Resyncing game $GAME_ID..."
        execute "(ai-actions/resync-game! \"$GAME_ID\")"
        ;;

    chat)
        ensure_connection
        MESSAGE="${1:-}"
        [[ -z "$MESSAGE" ]] && error "Usage: send_command chat <message>"
        info "Sending chat message..."
        execute "(ai-actions/send-chat! \"$MESSAGE\")"
        ;;

    # Installation
    install)
        ensure_connection
        CARD_NAME="${1:-}"
        SERVER="${2:-}"
        [[ -z "$CARD_NAME" ]] && error "Usage: send_command install <card-name> [server]"
        if [[ -n "$SERVER" ]]; then
            info "Installing card: $CARD_NAME on $SERVER"
            execute "(ai-actions/install-card! \"$CARD_NAME\" \"$SERVER\")"
        else
            info "Installing card: $CARD_NAME"
            execute "(ai-actions/install-card! \"$CARD_NAME\")"
        fi
        ;;

    install-index)
        ensure_connection
        INDEX="${1:-}"
        SERVER="${2:-}"
        [[ -z "$INDEX" ]] && error "Usage: send_command install-index <0-4> [server]"
        [[ ! "$INDEX" =~ ^[0-9]+$ ]] && error "Index must be a number"
        if [[ -n "$SERVER" ]]; then
            info "Installing card at index $INDEX on $SERVER"
            execute "(ai-actions/install-card! $INDEX \"$SERVER\")"
        else
            info "Installing card at index $INDEX"
            execute "(ai-actions/install-card! $INDEX)"
        fi
        ;;

    # Advanced
    eval)
        EXPR="${1:-}"
        [[ -z "$EXPR" ]] && error "Usage: send_command eval '<clojure-expression>'"
        execute "$EXPR"
        ;;

    # Unknown command
    *)
        error "Unknown command: $COMMAND\nRun './send_command help' for usage"
        ;;
esac
